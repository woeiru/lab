#!/bin/bash
set -o pipefail

# Source constants first - the foundation of the system
source "$LAB_DIR/dic/onst" || {
    echo "Failed to source constants" >&2
    exit 1
}

# Source verification module - validates the environment
source "$LAB_DIR/dic/veri" || {
    echo "Failed to source verification module" >&2
    exit 1
}

# Source initialization module - sets up the system
source "$LAB_DIR/dic/init" || {
    echo "Failed to source initialization module" >&2
    exit 1
}

echo " ─── initializing"
# Execute initialization from init module
init_rc
RC_STATUS=$?

if [ $RC_STATUS -ne 0 ]; then
    echo "RC initialization failed with status $RC_STATUS. Check /tmp/rc_init.log for details" >&2
    # Create essential directories as last resort
    for dir in "$LOG_DIR" "$TMP_DIR"; do
        mkdir -p "$dir" 2>/dev/null
    done

    # Set up minimal environment to keep shell usable
    echo "Setting up minimal environment..." >&2
    export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$HOME/bin"
    PS1="(minimal)[\u@\h \W]\$ "
fi

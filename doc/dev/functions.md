<!-- 
    This documentation focuses exclusively on generic pure functions from the lib/ folder.
    Pure functions are stateless, parameterized, and environment-independent.
    They provide predictable behavior and are fully testable with explicit inputs.
    
    The lib/ folder contains three categories of pure functions:
    - lib/core/  : Core system utilities (error handling, logging, timing)
    - lib/ops/   : Operations functions (infrastructure management)
    - lib/gen/   : General utilities (environment, security, infrastructure)
-->

# Pure Functions Reference

Generic pure functions available in the Lab Environment Management System.

## üìö Library Structure

The `lib/` folder contains three categories of pure functions:

### Core Utilities (`lib/core/`)
- **err**: Error handling and stack traces
- **lo1**: Module-specific debug logging
- **tme**: Performance timing and monitoring
- **ver**: Module version verification

### Operations Functions (`lib/ops/`)
- **aux**: Auxiliary operations and utilities
- **gpu**: GPU passthrough management
- **net**: Network configuration and management
- **pbs**: Proxmox Backup Server operations
- **pve**: Proxmox VE cluster management
- **srv**: System service operations
- **sto**: Storage and filesystem management
- **sys**: System-level operations
- **usr**: User account management

### General Utilities (`lib/gen/`)
- **env**: Environment configuration utilities
- **inf**: Infrastructure deployment utilities
- **sec**: Security and credential management
- **ssh**: SSH key and connection management

## üîç Function Metadata Table

<!-- AUTO-GENERATED SECTION: DO NOT EDIT MANUALLY -->
<!-- Command: aux-ffl aux-laf "" "$LIB_CORE_DIR" & aux-ffl aux-laf "" "$LIB_OPS_DIR" & aux-ffl aux-laf "" "$LIB_GEN_DIR" -->

*Auto-updated function metadata table with real-time analysis*

> **Last Updated**: 2025-06-01 05:25:31  
> **Generated By**: `utl/doc-func`  
> **Total Functions**: 209 functions across all libraries

This table provides a comprehensive overview of all functions available across the lab environment libraries:

### **üìã Function Library Overview**
Functions are organized by library modules for systematic access and reference.

### **üìñ Function Metadata Table**

| Library | Module | Function | Description |
|---------|--------|----------|-------------|
| core | err | err_process_error | Process error messages and log them appropriately |
| core | err | err_lo1_handle_error | Function to handle errors more comprehensively |
| core | err | clean_exit | Ensure clean exit from the script with proper trap cleanup |
| core | err | has_errors | Check if a component has any recorded errors |
| core | err | error_handler | Enhanced error handler that catches real errors when trapping enabled |
| core | err | enable_error_trap | Enable error trapping to catch command failures automatically |
| core | err | disable_error_trap | Disable error trapping to prevent automatic script termination |
| core | err | dangerous_operation | Example of wrapping dangerous operations with error trapping |
| core | err | safe_operation | Example of safe operations that don't need error trapping |
| core | err | print_error_report | Generate comprehensive error report with categorized issues |
| core | err | setup_error_handling | Initialize error handling system and clear existing tracking |
| core | err | register_cleanup | Register cleanup function for module teardown operations |
| core | err | main_cleanup | Orchestrate cleanup sequence for all registered modules |
| core | err | main_error_handler | Central error handler that delegates to module error handlers |
| core | err | init_traps | Initialize trap system with EXIT and ERR handlers |
| core | lo1 | lo1_debug_log | Enhanced debug logging - moved to top |
| core | lo1 | get_cached_log_state | Retrieve cached log state to optimize file access performance |
| core | lo1 | dump_stack_trace | Display detailed stack trace for debugging function calls |
| core | lo1 | cleanup_cache | Periodic cleanup of depth cache to optimize performance |
| core | lo1 | ensure_state_directories | Create required logging directories if they don't exist |
| core | lo1 | init_state_files | Initialize state files for logging |
| core | lo1 | is_root_function | Check if given function is a root function for depth calculation |
| core | lo1 | get_base_depth | Calculate base depth for call stack indentation in logs |
| core | lo1 | calculate_final_depth | Calculate final depth for logging |
| core | lo1 | get_indent | Get indentation string based on depth |
| core | lo1 | get_color | Get color based on depth level |
| core | lo1 | log | Main logging function |
| core | lo1 | setlog | Logger control |
| core | lo1 | init_logger | Initialize logger system and setup logging environment |
| core | lo1 | cleanup_logger | Clean up logger state and reset cache variables |
| core | lo1 | lo1_log_message | Standard logging function for modules to use |
| core | lo1 | lo1_tme_log_with_timer | Log message with timing information if TME module available |
| core | tme | tme_init_timer | Initialize timer system with log directory and configuration files |
| core | tme | tme_start_timer | Start timing a component with optional parent for nested timing |
| core | tme | tme_stop_timer | Stop timing for component using end_timer for compatibility |
| core | tme | tme_end_timer | End timing for component and calculate duration |
| core | tme | calculate_component_depth | Calculate depth of component in timing tree hierarchy |
| core | tme | print_timing_entry | Print formatted timing entry with color and indentation |
| core | tme | sort_components_by_duration | Sort array of component names by their durations in descending order |
| core | tme | print_tree_recursive | Recursively print component tree with proper indentation and sorting |
| core | tme | tme_settme | Control timer output settings for report, sort order and depth |
| core | tme | tme_print_timing_report | Generate comprehensive timing report with hierarchical display |
| core | tme | tme_start_nested_timing | Start nested timing for a component with automatic parent tracking |
| core | tme | tme_end_nested_timing | End nested timing for a component with success status |
| core | tme | tme_cleanup_timer | Cleanup timer system and end any running timers |
| core | tme | tme_set_output | Control individual TME terminal output verbosity settings |
| core | tme | tme_show_output_settings | Display current TME terminal output verbosity configuration |
| core | ver | ver_log | Debug logging with timestamp and conditional terminal output |
| core | ver | verify_path | Verify path existence and optionally create if missing |
| core | ver | verify_var | Verify that a variable is set and not empty |
| core | ver | essential_check | Perform essential checks for critical system variables and paths |
| core | ver | verify_module | Verify module integrity using configuration data and validation |
| core | ver | validate_module | Validate module file existence, permissions and shebang |
| core | ver | verify_function_dependencies | Verify that all dependencies for a function are available |
| core | ver | verify_function | Verify function exists in specified module file |
| core | ver | init_verification | Initialize verification system and perform essential checks |
| ops | aux | aux-fun | Shows a summary of selected functions in the script, displaying their usage, shortname, and description |
| ops | aux | aux-var | Displays an overview of specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | aux | aux-log | Logging function. Prints a timestamped log message with a log level |
| ops | aux | aux-ffl | Recursively processes files in a directory and its subdirectories using a specified function, allowing for additional arguments to be passed |
| ops | aux | aux-laf | Lists all functions in a file, displaying their usage, shortname, and description. Supports truncation and line break options for better readability |
| ops | aux | aux-acu | Analyzes the usage of variables from a config file across target folders, displaying variable names, values, and occurrence counts in various files |
| ops | aux | aux-mev | Prompts the user to input or confirm a variable's value, allowing for easy customization of script parameters |
| ops | aux | aux-nos | Logs a function's execution status with a timestamp, providing a simple way to track script progress and debugging information |
| ops | aux | aux-flc | Displays the source code of a specified function from the library folder, including its description, shortname, and usage |
| ops | aux | aux-use | Displays the usage information, shortname, and description of the calling function, helping users understand how to use it |
| ops | gpu | _gpu_init_colors | Initialize color constants for GPU management output formatting |
| ops | gpu | _gpu_validate_pci_id | Validate PCI ID format using regex pattern matching |
| ops | gpu | _gpu_extract_vendor_device_id | Extract vendor and device IDs from lspci output for PCI device |
| ops | gpu | _gpu_get_current_driver | Get current driver bound to specified PCI device |
| ops | gpu | _gpu_is_gpu_device | Check if PCI device is GPU-related hardware type |
| ops | gpu | _gpu_load_config | Load GPU configuration file if available and readable |
| ops | gpu | _gpu_get_config_pci_ids | Get PCI IDs from hostname-based configuration variables |
| ops | gpu | _gpu_find_all_gpus | Find all GPU devices via lspci scan with optional driver filter |
| ops | gpu | _gpu_get_target_gpus | Get target GPUs for processing with comprehensive selection logic |
| ops | gpu | _gpu_ensure_vfio_modules | Ensure required VFIO kernel modules are loaded for GPU passthrough |
| ops | gpu | _gpu_unbind_device | Unbind PCI device from its current driver safely |
| ops | gpu | _gpu_bind_device | Bind PCI device to specified driver with vendor/device ID setup |
| ops | gpu | _gpu_get_host_driver | Determine appropriate host driver for GPU based on vendor ID |
| ops | gpu | _gpu_get_host_driver_parameterized | Determine appropriate host driver for GPU with explicit parameters |
| ops | gpu | _gpu_get_config_pci_ids_parameterized | Get PCI IDs from explicit parameters without hostname lookup |
| ops | gpu | _gpu_get_target_gpus_parameterized | Get target GPUs for processing with explicit parameters |
| ops | gpu | _gpu_get_iommu_groups | Get IOMMU groups containing GPU devices for passthrough validation |
| ops | gpu | _gpu_get_detailed_device_info | Get detailed GPU device information including driver status and bindings |
| ops | gpu | gpu-fun | Shows a summary of selected functions in the script, displaying their usage, shortname, and description |
| ops | gpu | gpu-var | Displays an overview of specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | gpu | gpu-nds | Downloads and installs NVIDIA drivers, blacklisting Nouveau drivers first |
| ops | gpu | gpu-pt1 | Configures initial GRUB and EFI settings for GPU passthrough |
| ops | gpu | gpu-pt2 | Adds necessary kernel modules for GPU passthrough |
| ops | gpu | gpu-pt3 | Finalizes or reverts GPU passthrough setup |
| ops | gpu | gpu-ptd | Detaches the GPU from the host system for VM passthrough |
| ops | gpu | gpu-pta | Attaches the GPU back to the host system |
| ops | gpu | gpu-pts | Checks the current status of the GPU (complete detailed version) |
| ops | net | net-fun | Displays an overview of specific functions in the script, showing their usage, shortname, and description |
| ops | net | net-var | Displays an overview of specific variables in network configuration |
| ops | net | net-uni | Guides the user through renaming a network interface by updating udev rules and network configuration, with an option to reboot the system |
| ops | net | net-fsr | Adds a specified service to the firewalld configuration and reloads the firewall. Checks for the presence of firewall-cmd before proceeding |
| ops | net | net-fas | Allows a specified service through the firewall using firewall-cmd, making the change permanent and reloading the firewall configuration |
| ops | pbs | pbs-fun | show an overview of specific functions |
| ops | pbs | pbs-var | show an overview of specific variables |
| ops | pbs | pbs-dav | Download Proxmox GPG key and verify checksums. |
| ops | pbs | pbs-adr | Add Proxmox repository to sources.list if not already present. |
| ops | pbs | pbs-rda | Restore datastore configuration file with given parameters. |
| ops | pbs | pbs-mon | Monitors and displays various aspects of the Proxmox Backup Server |
| ops | pve | pve-fun | Displays an overview of specific Proxmox Virtual Environment (PVE) related functions in the script, showing their usage, shortname, and description |
| ops | pve | pve-var | Displays an overview of PVE-specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | pve | pve-dsr | Disables specified Proxmox repository files by commenting out 'deb' lines, typically used to manage repository sources  |
| ops | pve | pve-rsn | Removes the Proxmox subscription notice by modifying the web interface JavaScript file, with an option to restart the pveproxy service  |
| ops | pve | pve-clu | Updates the Proxmox VE Appliance Manager (pveam) container template list |
| ops | pve | pve-cdo | Downloads a specified container template to a given storage location, with error handling and options to list available templates |
| ops | pve | pve-cbm | Configures a bind mount for a specified Proxmox container, linking a host directory to a container directory |
| ops | pve | pve-ctc | Sets up different containers specified in cfg/env/site. |
| ops | pve | pve-cto | Manages multiple Proxmox containers by starting, stopping, enabling, or disabling them, supporting individual IDs, ranges, or all containers |
| ops | pve | pve-vmd | Deploys or modifies the VM shutdown hook for GPU reattachment |
| ops | pve | pve-vmc | Sets up different virtual machines specified in cfg/env/site. |
| ops | pve | pve-vms | Starts a VM on the current node or migrates it from another node, with an option to shut down the source node after migration |
| ops | pve | pve-vmg | Migrates a VM from a remote node to the current node, handling PCIe passthrough disable/enable during the process |
| ops | pve | pve-vpt | Toggles PCIe passthrough configuration for a specified VM, modifying its configuration file to enable or disable passthrough devices |
| ops | pve | pve-vck | Checks and reports which node in the Proxmox cluster is currently hosting a specified VM |
| ops | srv | srv-fun | Displays an overview of specific NFS-related functions in the script, showing their usage, shortname, and description |
| ops | srv | srv-var | Displays an overview of NFS-specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | srv | nfs-set | Sets up an NFS share by prompting for necessary information (NFS header, shared folder, and options) and applying the configuration |
| ops | srv | nfs-apl | Applies NFS configuration by creating the shared folder if needed, updating /etc/exports, and restarting the NFS server |
| ops | srv | nfs-mon | Monitors and displays various aspects of the NFS server |
| ops | srv | smb-set | Sets up a Samba share by prompting for missing configuration details and applying the configuration. Handles various share parameters including permissions, guest access, and file masks |
| ops | srv | smb-apl | Applies Samba configuration by creating the shared folder if needed, updating cfg/env/site. with share details, restarting the Samba service, and setting up user passwords. Supports both user-specific and 'nobody' shares |
| ops | srv | smb-mon | Monitors and displays various aspects of the SMB server |
| ops | sto | sto-fun | Displays an overview of specific functions in the script, showing their usage, shortname, and description |
| ops | sto | sto-var | Displays an overview of specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | sto | sto-fea | Adds auto-mount entries for devices to /etc/fstab using blkid. Allows user to select a device UUID and automatically creates the appropriate fstab entry |
| ops | sto | sto-fec | Adds custom entries to /etc/fstab using device UUIDs. Allows user to specify mount point, filesystem, mount options, and other parameters |
| ops | sto | sto-nfs | Mounts an NFS share interactively or with provided arguments |
| ops | sto | sto-bfs-tra | Transforms a folder into a Btrfs subvolume, optionally setting attributes (e.g., disabling COW). Handles multiple folders, preserving content and ownership. |
| ops | sto | sto-bfs-ra1 | Creates a Btrfs RAID 1 filesystem on two specified devices, mounts it, and optionally adds an entry to /etc/fstab |
| ops | sto | sto-bfs-csf | Checks and lists subvolume status of folders in a specified path. Supports filtering by folder type (regular, hidden, or both) and subvolume status. |
| ops | sto | sto-bfs-shc | Creates a new Snapper snapshot for the specified configuration or automatically selects a 'home_*' configuration if multiple exist |
| ops | sto | sto-bfs-shd | Deletes a specified Snapper snapshot from a given configuration or automatically selects a 'home_*' configuration if multiple exist |
| ops | sto | sto-bfs-shl | Lists Snapper snapshots for the specified configuration or automatically selects a 'home_*' configuration if multiple exist |
| ops | sto | sto-bfs-sfr | Resyncs a Btrfs snapshot subvolume to a flat folder using rsync, excluding specific directories (.snapshots and .ssh) and preserving attributes |
| ops | sto | sto-bfs-hub | Creates a backup subvolume for a user's home directory on a backup drive, then sends and receives Btrfs snapshots incrementally, managing full and incremental backups |
| ops | sto | sto-bfs-snd | Recursively deletes a Btrfs parent subvolume and all its nested child subvolumes, with options for interactive mode and forced deletion |
| ops | sto | sto-zfs-cpo | Creates a ZFS pool on a specified drive in a Proxmox VE environment |
| ops | sto | sto-zfs-dim | Creates a new ZFS dataset or uses an existing one, sets its mountpoint, and ensures it's mounted at the specified path |
| ops | sto | sto-zfs-dbs | Creates and sends ZFS snapshots from a source pool to a destination pool. Supports initial full sends and incremental sends for efficiency |
| ops | sys | sys-fun | Shows a summary of specific functions in the script, displaying their usage, shortname, and description |
| ops | sys | sys-var | Displays an overview of specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | sys | sys-gio | Manages git operations, ensuring the local repository syncs with the remote. |
| ops | sys | sys-dpa | Detects the system's package manager |
| ops | sys | sys-upa | Updates and upgrades system packages using the detected package manager |
| ops | sys | sys-ipa | Installs specified packages using the system's package manager |
| ops | sys | sys-gst | Configures git globally with a specified username and email, essential for proper commit attribution |
| ops | sys | sys-sst | Installs, enables, and starts the sysstat service for system performance monitoring. Modifies the configuration to ensure it's enabled |
| ops | sys | sys-ust | Creates a new user with a specified username and password, prompting for input if not provided. Verifies successful user creation |
| ops | sys | sys-sdc | Enables and starts a specified systemd service. Checks if the service is active and prompts for continuation if it's not |
| ops | sys | sys-suk | Uploads an SSH key from a plugged-in device to a specified folder (default: /root/.ssh). Handles mounting, file copying, and unmounting of the device |
| ops | sys | sys-spi | Appends a private SSH key identifier to the SSH config file for a specified user. Creates the .ssh directory and config file if they don't exist |
| ops | sys | sys-sks | Generates an SSH key pair and handles the transfer process |
| ops | sys | sys-sak | Appends the content of a specified public SSH key file to the authorized_keys file. |
| ops | sys | sys-loi | Loops a specified SSH operation (bypass StrictHostKeyChecking or refresh known_hosts) through a range of IPs defined in the configuration |
| ops | sys | sys-sca | Resolves custom SSH aliases using the configuration file. Supports connecting to single or multiple servers, executing commands remotely |
| ops | sys | sys-gre | An interactive Bash function that guides users through Git history navigation, offering options for reset type and subsequent actions, with built-in safeguards and explanations. |
| ops | sys | sys-hos | Adds or updates a host entry in /etc/hosts. If IP or hostname is empty, logs an error and exits. |
| ops | usr | usr-fun | Shows a summary of selected functions in the script, displaying their usage, shortname, and description |
| ops | usr | usr-var | Displays an overview of specific variables defined in the configuration file, showing their names, values, and usage across different files |
| ops | usr | usr-ckp | Changes the Konsole profile for the current user by updating the konsolerc file |
| ops | usr | usr-vsf | Prompts the user to select a file from the current directory by displaying a numbered list of files and returning the chosen filename |
| ops | usr | usr-cff | Counts files in directories based on specified visibility (regular, hidden, or both). Displays results sorted by directory name |
| ops | usr | usr-duc | Compares data usage between two paths up to a specified depth. Displays results in a tabular format with color-coded differences |
| ops | usr | usr-cif | Concatenates and displays the contents of all files within a specified folder, separating each file's content with a line of dashes |
| ops | usr | usr-rsf | Replaces strings in files within a specified folder and its subfolders. If in a git repository, it stages changes and shows the diff |
| ops | usr | usr-rsd | Performs an rsync operation from a source to a destination path. Displays files to be transferred and prompts for confirmation before proceeding |
| ops | usr | usr-swt | Schedules a system wake-up using rtcwake. Supports absolute or relative time input and different sleep states (mem/disk) |
| ops | usr | usr-adr | Adds a specific line to a target if not already present |
| ops | usr | usr-cap | Appends a line to a file if it does not already exist, preventing duplicate entries and providing feedback on the operation |
| ops | usr | usr-rif | Replaces all occurrences of a string in files within a given folder |
| ops | usr | usr-ans | Navigates to the Ansible project directory, runs the playbook, then returns to the original directory |
| gen | env | update_ecc | Helper function to update environment controller configuration |
| gen | env | env_switch | Switch environment (dev/test/staging/prod) with validation |
| gen | env | site_switch | Switch site configuration with validation and listing |
| gen | env | node_switch | Switch node configuration for cluster deployments |
| gen | env | env_status | Show current environment status with configuration hierarchy display |
| gen | env | env_list | List available environments and overrides with discovery |
| gen | env | env_validate | Validate configuration files existence and accessibility |
| gen | env | env_usage | Show usage information and command examples |
| gen | env | main | Main function for command-line usage and argument processing |
| gen | inf | set_container_defaults | Set container defaults (can be called to override global defaults) |
| gen | inf | generate_ip_sequence | Generate sequential IP addresses for network planning |
| gen | inf | define_container | Define a container with minimal parameters and default fallbacks |
| gen | inf | define_containers | Define multiple containers from a configuration string with colon separation |
| gen | inf | set_vm_defaults | Set VM defaults for virtual machine configuration |
| gen | inf | define_vm | Define a VM with minimal parameters and default fallbacks |
| gen | inf | define_vms | Define multiple VMs from colon-separated string with bulk creation |
| gen | inf | validate_config | Validate configuration completeness and consistency |
| gen | inf | show_config_summary | Show configuration summary with overview of containers and VMs |
| gen | sec | generate_secure_password | Generate a secure password with specified length |
| gen | sec | store_secure_password | Generate a secure password and store it in a variable |
| gen | sec | generate_service_passwords | Generate multiple passwords for different services and store them |
| gen | sec | create_password_file | Create a password file with proper permissions and security |
| gen | sec | load_stored_passwords | Load passwords from secure storage into environment variables |
| gen | sec | get_password_directory | Get the appropriate password directory based on system capabilities |
| gen | sec | init_password_management | Initialize secure password management system with directory setup |
| gen | sec | init_password_management_auto | Initialize password management with automatic directory selection |
| gen | sec | get_password_file | Get password file path with fallback mechanism and validation |
| gen | sec | get_secure_password | Get password with smart lookup and generation fallback |
| gen | ssh | set_ssh | Set up SSH environment with keys and aliases |
| gen | ssh | setup_ssh | Set up SSH keys and create convenient aliases |
| gen | ssh | add_ssh_keys | Add SSH keys to the SSH agent for authentication |
| gen | ssh | list_ssh_keys | List SSH keys currently loaded in the agent |
| gen | ssh | remove_ssh_keys | Remove all SSH keys from the agent |

<!-- END AUTO-GENERATED SECTION -->

## üéØ Pure Function Characteristics

### Design Principles
- **Stateless**: No global state dependencies
- **Parameterized**: All inputs via explicit parameters
- **Predictable**: Same inputs always produce same outputs
- **Testable**: Can be tested in isolation

### Usage Pattern
```bash
# Pure function call
function_name "param1" "param2" "param3"

# No environment variables required
# No side effects on global state
# Fully deterministic behavior
```

## üîß Integration

To use pure functions in your scripts:

```bash
# Source the required library modules
source "$LIB_CORE_DIR/err"
source "$LIB_OPS_DIR/pve"
source "$LIB_GEN_DIR/inf"

# Call functions with explicit parameters
pve-vmc "101" "node1,node2,node3"
handle_error "component" "message" "ERROR"
```

## üìñ Related Documentation

- **[System Architecture](architecture.md)** - Complete system design
- **[Logging System](logging.md)** - Debug and logging frameworks
- **[Verbosity Controls](verbosity.md)** - Output control mechanisms

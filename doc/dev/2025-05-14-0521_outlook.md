<!--
#######################################################################
# Development Session Outlook - lo2 Module Troubleshooting
#######################################################################
# File: /home/es/lab/doc/dev/2025-05-14-0521_outlook.md
# Description: Development notes and troubleshooting documentation for
#              the lo2 module control structure depth tracking system
#              and planned next steps for resolving log indentation issues.
#
# Session Context:
#   Focus on diagnosing and resolving the log indentation "plateau"
#   effect in the lo2 module responsible for control structure depth
#   tracking within the advanced logging system architecture.
#
# Technical Scope:
#   - lo2 module analysis (lib/util/lo2)
#   - Control structure depth calculation debugging
#   - Log indentation system troubleshooting
#   - Integration with lo1 advanced logging module
#
# Target Audience:
#   Developers working on logging system improvements, debugging
#   specialists, and technical leads responsible for system
#   architecture maintenance and enhancement.
#######################################################################
-->

# Outlook & Next Steps - 2025-05-14 ~05:20

**Current Situation:**

We have been troubleshooting the `lo2` module (`/home/es/lab/lib/util/lo2`) which is responsible for control structure depth tracking. The primary goal is to fix a log indentation "plateau" effect, believed to be caused by `lo2` not correctly reporting depth.

Key issues encountered and resolved with `lo2`:
1.  Premature script exit before full initialization (resolved by careful review and modification of global `declare` statements and initial logging calls).
2.  Incorrect `DEBUG` trap command definition (`trap_command` literal instead of the actual command string), leading to "command not found" errors (resolved by correcting the `new_trap_command` variable in `install_depth_tracking`).

**Last Confirmed State of `lo2` (`/home/es/lab/lib/util/lo2`):

*   The script initializes past global variable declarations (up to "Point H" in previous diagnostics).
*   The `lo2_debug_log` function is operational.
*   The `DEBUG` trap in `install_depth_tracking` is set to a simplified diagnostic command: `echo "RAW DEBUG TRAP FIRED: CMD=$BASH_COMMAND SRC=${BASH_SOURCE[0]} LINE=${BASH_LINENO[0]} Timestamp: $(date '\''+%H:%M:%S.%N'\'')'" >> "/home/es/lab/.log/lo2_trap_fire.log"`.

**Immediate Issue (as of last interaction):**

*   Despite corrections to `install_depth_tracking`, the `lo2.log` indicates that the `lo2` script still appears to be exiting after "Point H" (after global var declarations, before function definitions like `install_depth_tracking` or `setlogcontrol` are called from within `lo2`'s own initialization block at the end of the script).
*   Consequently, `/home/es/lab/.log/lo2_trap_fire.log` is not being created, indicating the `DEBUG` trap is not being set by `lo2`'s final initialization logic that calls `setlogcontrol "on"`.

**Next Steps to Investigate:**

1.  **Verify `init` Script Sourcing and `setlogcontrol` Call:**
    *   **Action:** Manually inspect the main `init` script (e.g., `/home/es/lab/bin/init` or a variant like `verbose_init`).
    *   **Confirm:**
        *   That `/home/es/lab/lib/util/lo2` is being sourced.
        *   That `setlogcontrol "on"` is being called *after* `lo2` is sourced.
        *   The *exact point* of sourcing `lo2` and calling `setlogcontrol "on"` in the `init` script's execution flow.

2.  **Trace Execution from `init` into `lo2`:**
    *   **If `lo2.log` continues to show an early exit:**
        *   Add diagnostic `echo "INIT_SCRIPT_FLOW: About to source lo2 - $(date '+%T.%N')" >> /home/es/lab/.log/init_flow.log` just *before* sourcing `lo2` in the `init` script.
        *   Add `echo "INIT_SCRIPT_FLOW: Sourced lo2, about to call setlogcontrol on - $(date '+%T.%N')" >> /home/es/lab/.log/init_flow.log` just *before* calling `setlogcontrol "on"`.
        *   Add `echo "INIT_SCRIPT_FLOW: Called setlogcontrol on - $(date '+%T.%N')" >> /home/es/lab/.log/init_flow.log` just *after* calling `setlogcontrol "on"`.
        *   At the very top of `/home/es/lab/lib/util/lo2` (before `verify_module`), add: `echo "LO2_TRACE: lo2 script execution started - $(date '+%T.%N')" >> /home/es/lab/.log/lo2_entry_trace.log`.
    *   **Analyze:** Compare timestamps in `init_flow.log`, `lo2_entry_trace.log`, and `lo2.log` to pinpoint where execution stops or if `lo2` is even reached by the `init` script as expected.

3.  **Examine `lo2` Initialization Block (End of Script):**
    *   The block at the end of `lo2` that checks `LOG_CONTROL_STATE_FILE` and calls `setlogcontrol "on"` or `"off"` is critical. If the script exits before this, the trap won't be installed.
    *   Review `lo2.log` for messages from this block (e.g., "Found control state file...", "setlogcontrol CALLED with on"). The last log showed it was *not* reaching this far.

**Ultimate Goal for this Phase:**
*   Ensure `/home/es/lab/.log/lo2_trap_fire.log` is created and populated, confirming the simplified `DEBUG` trap is successfully set and triggered.

Once the simplified trap fires, the plan is to:
1.  Restore the `DEBUG` trap in `install_depth_tracking` to call `track_control_depth "$BASH_COMMAND" "${BASH_SOURCE[0]}" "${BASH_LINENO[0]}"`.
2.  Investigate why `track_control_depth` isn't logging control structure changes.
3.  Finally, address the original log indentation plateau.

# RTX 50 Series GPU Passthrough Issues

## Overview

This document details the investigation and troubleshooting steps for RTX 5060 Ti GPU passthrough issues on Proxmox node `x1`. The GPU passthrough setup works correctly on other nodes but fails to display output on this specific node despite successful technical configuration.

## Problem Description

**Symptoms:**
- GPU detaches from host successfully (`gpu-ptd` works without errors)
- VM starts and runs without errors
- GPU is properly bound to vfio-pci driver
- **No display output** from the GPU in the VM
- Same configuration works on other Proxmox nodes

**Hardware:**
- GPU: NVIDIA RTX 5060 Ti (Device ID: `10de:2d04`)
- Node: Proxmox x1 (6.8.12-10-pve kernel)
- VM: Windows 11 (VM ID 111)

## Initial Configuration

**VM Configuration:**
```
hostpci0: 0000:3b:00.0,pcie=1,x-vga=1
hostpci1: 0000:3b:00.1,pcie=1
bios: ovmf
machine: pc-q35-9.2+pve1
```

**Kernel Parameters (Initial):**
```
GRUB_CMDLINE_LINUX_DEFAULT="quiet iommu=pt"
```

## Troubleshooting Steps Attempted

### 1. PCIe Power Management Fix

Based on similar RTX 50 series issues reported in forums, we tried disabling PCIe power management:

**Added kernel parameter:**
```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet iommu=pt pcie_port_pm=off"
```

**Result:** No improvement in display output.

### 2. Additional PCIe Compatibility Parameters

Added more RTX 50 series compatibility parameters:

**Updated kernel parameters:**
```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet iommu=pt pcie_port_pm=off pci=nommconf pcie_aspm=off"
```

**Result:** No improvement in display output.

### 3. ROM BAR Configuration

**Attempted:**
```bash
qm set 111 -hostpci0 0000:3b:00.0,pcie=1,x-vga=1,rombar=1
```

**Result:** Caused system instability, VM hangs. Configuration was reverted.

### 4. NVIDIA DRM Modeset Parameter

Based on forum reports specifically for RTX 50 series, implemented the `nvidia_drm modeset=1` parameter:

**Created `/etc/modprobe.d/nvidia.conf`:**
```
options nvidia_drm modeset=1
```

**Initial Issue:** Typo in configuration file (`modset=1` instead of `modeset=1`)

**After Fix:**
```bash
# Verification shows parameter is applied
cat /sys/module/nvidia_drm/parameters/modeset
# Output: Y
```

**Current Status:** Parameter correctly applied, testing ongoing.

## Technical Analysis

### Successful Operations
- ✅ GPU detachment works perfectly (`gpu-ptd`)
- ✅ VFIO binding successful
- ✅ VM starts without errors
- ✅ No PCIe power management errors in dmesg
- ✅ GPU shows "active" power state

### Key Observations

**VFIO Messages in dmesg:**
```
vfio-pci 0000:3b:00.0: vgaarb: deactivate vga console
vfio-pci 0000:3b:00.0: vgaarb: VGA decodes changed: olddecodes=none,decodes=io+mem:owns=none
vfio-pci 0000:3b:00.0: Enabling HDA controller
```

**Power State Check:**
```bash
cat /sys/bus/pci/devices/0000:3b:00.0/power/runtime_status
# Output: active
```

## Current Hypothesis

The issue appears to be related to RTX 50 series initialization requirements rather than traditional PCIe power management problems. The forum solution suggests a "chicken and egg" problem:

1. RTX 50 series cards need NVIDIA drivers installed in the VM to provide display output
2. Display output is needed to install NVIDIA drivers
3. The `nvidia_drm modeset=1` parameter helps break this cycle

## Next Steps

### Option 1: Virtual GPU Installation Method
1. Temporarily remove GPU passthrough
2. Add virtual display (vmware/qxl)
3. Install NVIDIA drivers using virtual display
4. Remove virtual display and re-add GPU passthrough
5. Test display output with drivers installed

### Option 2: NoVNC Access Method
Test if Proxmox web console (noVNC) provides access even without physical display output for driver installation.

### Option 3: Compare Working Node
Investigate differences between working node configuration and current node:
- Kernel versions
- Exact kernel parameters
- NVIDIA driver versions
- Hardware differences

## Configuration Files Status

**Current Kernel Parameters:**
```bash
cat /proc/cmdline
# BOOT_IMAGE=/boot/vmlinuz-6.8.12-10-pve root=/dev/mapper/pve-root ro quiet iommu=pt pcie_port_pm=off
```

**NVIDIA DRM Configuration:**
```bash
cat /etc/modprobe.d/nvidia.conf
# options nvidia_drm modeset=1

cat /sys/module/nvidia_drm/parameters/modeset
# Y
```

**GPU Status:**
```bash
gpu-pts
# Shows GPU properly detached and bound to vfio-pci
```

## References

- Forum post describing similar RTX 50 series issues
- Solution involving `nvidia_drm modeset=1` parameter
- Warning about rombar incompatibility with RTX 50 series
- Recommendation for virtual GPU installation method

## Notes

- RTX 50 series cards are relatively new and may require specific workarounds
- Traditional PCIe power management fixes don't appear to resolve this specific issue
- The `nvidia_drm modeset=1` parameter is crucial for RTX 50 series passthrough
- ROM BAR should be avoided with RTX 50 series cards

---

**Last Updated:** May 27, 2025  
**Status:** Investigating virtual GPU installation method with `nvidia_drm modeset=1` applied
#!/bin/bash

# Test script to isolate the library processing issue
LAB_DIR="/home/es/lab"
source "$LAB_DIR/lib/gen/aux"

process_library_functions() {
    local lib_name="$1"
    local lib_dir="$2"
    
    echo "=== DEBUG: Processing library '$lib_name' from directory '$lib_dir' ==="
    
    local tmp_dir="$LAB_DIR/.tmp/doc"
    
    for file in "$lib_dir"/*; do
        if [[ -f "$file" ]]; then
            echo "DEBUG: Processing file: $file"
            
            local relative_path="${file#$LAB_DIR/}"
            local json_filename="${relative_path//\//_}.json"
            local json_file="$tmp_dir/$json_filename"
            
            echo "DEBUG: Looking for JSON: $json_file"
            
            if [[ -f "$json_file" ]]; then
                local module_name=$(basename "$file")
                echo "DEBUG: Found JSON for module '$module_name' in library '$lib_name'"
                
                # Just extract function names to test
                grep '"name":' "$json_file" | head -3 | while read -r line; do
                    if [[ "$line" =~ \"name\":[[:space:]]*\"([^\"]+)\" ]]; then
                        func_name="${BASH_REMATCH[1]}"
                        echo "| $lib_name | $module_name | $func_name | test description |"
                    fi
                done
            else
                echo "DEBUG: No JSON found for $file"
            fi
        fi
    done
}

# Test with gen library specifically
echo "Testing gen library processing:"
process_library_functions "gen" "$LAB_DIR/lib/gen"

echo ""
echo "Testing ops library processing:"  
process_library_functions "ops" "$LAB_DIR/lib/ops"

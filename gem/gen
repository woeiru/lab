#!/bin/bash

declare -g -a PACKAGES_ALL

# Define script location
DIR_SH="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
FILE_SH="$(basename "${BASH_SOURCE[0]}")"
BASE_SH="${FILE_SH%.*}"

# Source .up which provides logging and other core functionality
source "$DIR_SH/.up"

setup_source "$DIR_SH" "$FILE_SH" "$BASE_SH"
echo "DEBUG: After setup_source - PACKAGES_ALL: ${PACKAGES_ALL[@]}"

# Declare MENU_OPTIONS
declare -A MENU_OPTIONS
MENU_OPTIONS[a]="a_xall"
MENU_OPTIONS[b]="b_xall"
MENU_OPTIONS[x]="x_xall"

# Installs common system packages and configures global Git user credentials
a_xall() {
    echo "Debug: Entering a_xall function"
    echo "Debug: Current directory: $(pwd)"
    echo "Debug: PACKAGES_ALL contents: ${PACKAGES_ALL[@]}"
    echo "Debug: Number of packages: ${#PACKAGES_ALL[@]}"

    if [ ${#PACKAGES_ALL[@]} -eq 0 ]; then
        echo "Error: PACKAGES_ALL array is empty"
        return 1
    fi

    echo "Debug: About to execute: gen-ipa ${PACKAGES_ALL[@]}"
    gen-ipa "${PACKAGES_ALL[@]}"
    local result=$?
    echo "Debug: gen-ipa exit code: $result"
    return $result
}

# Uploads private SSH key from USB device to system for secure authentication
b_xall() {
    gen-suk \
        "$DEVICE_PATH" \
        "$MOUNT_POINT" \
        "$SUBFOLDER_PATH" \
        "$UPLOAD_PATH" \
        "$PRIVATE_KEY"
}

# Handle script execution
if [ $# -eq 0 ]; then
    print_usage
    clean_exit 0       # Exit cleanly with status 0
else
    echo "DEBUG: Before setup_main - PACKAGES_ALL: ${PACKAGES_ALL[@]}"
    setup_main "$@"
    exit_code=$?
    echo "DEBUG: After setup_main - PACKAGES_ALL: ${PACKAGES_ALL[@]}"
    exit $exit_code
    clean_exit $?
fi

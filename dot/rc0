#!/bin/bash
# rc0 - Common Functions and Logging

# Logging control array
# Index 0: LVL1 (RED), Index 1: LVL2 (ORANGE), Index 2: LVL3 (YELLOW), Index 3: LVL4 (GREEN),
# Index 4: LVL5 (CYAN), Index 5: LVL6 (BLUE), Index 6: LVL7 (INDIGO), Index 7: LVL8 (VIOLET)
LOG_LEVELS=(1 1 1 1 1 1 1 1)

# Color codes (only for indentation)
RED='\033[0;31m'
ORANGE='\033[0;33m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
INDIGO='\033[0;35m'
VIOLET='\033[1;35m'
NC='\033[0m' # No Color

# Logging function
log() {
    local level=$1
    local message=$2
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")
    local level_num=${level#LVL}
    local indent=""
    local color=""

    # Set color based on level
    case $level in
        "LVL1") color=$RED ;;
        "LVL2") color=$ORANGE ;;
        "LVL3") color=$YELLOW ;;
        "LVL4") color=$GREEN ;;
        "LVL5") color=$CYAN ;;
        "LVL6") color=$BLUE ;;
        "LVL7") color=$INDIGO ;;
        "LVL8") color=$VIOLET ;;
        *) color=$NC ;;
    esac

    # Create indentation and colored indicator
    if [ $level_num -eq 1 ]; then
        indent="${color}└─${NC}"
    else
        indent="  ${color}└─${NC}"
        for i in $(seq 3 $level_num); do
            indent="  $indent"
        done
    fi

    # Output log message
    if [[ ${LOG_LEVELS[$((level_num-1))]} -eq 1 ]]; then
        if [ $level_num -eq 1 ]; then
            echo -e "${timestamp} ${indent}$level: $message" >&2
        else
            echo -e "${timestamp} ${indent}$level: $message"
        fi
    fi
}

# Function to set up logging
setup_logging() {
    local log_config=($@)
    for i in {0..7}; do
        LOG_LEVELS[$i]=${log_config[$i]:-${LOG_LEVELS[$i]}}
    done
    log "LVL4" "Logging set up with levels: ${LOG_LEVELS[*]}"
}

# Utility function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Utility function to source a file if it exists
source_if_exists() {
    if [ -f "$1" ]; then
        source "$1"
        log "LVL3" "Sourced file: $1"
    else
        log "LVL1" "File not found: $1"
    fi
}

# Export functions and variables
export -f log
export -f setup_logging
export -f command_exists
export -f source_if_exists
export LOG_LEVELS

#!/bin/bash

# Define directory and file variables
DIR_FUN="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
FILE_FUN=$(basename "$BASH_SOURCE")
BASE_FUN="${FILE_FUN%.*}"
FILEPATH_FUN="${DIR_FUN}/${FILE_FUN}"
CONFIG_FUN="${SITE_CONFIG_FILE}"

# Dynamically create variables based on the base name
eval "FILEPATH_${BASE_FUN}=\$FILEPATH_FUN"
eval "FILE_${BASE_FUN}=\$FILE_FUN"
eval "BASE_${BASE_FUN}=\$BASE_FUN"
eval "CONFIG_${BASE_FUN}=\$CONFIG_FUN"

# Shows function overview with optional filtering
# overview functions
# [function_name_filter]
pbs_fun() {
    # Technical Description:
    #   Displays formatted list of all functions in the PBS module
    #   Uses aux_laf utility to parse function definitions and extract documentation
    #   Provides optional filtering by function name pattern
    #   Shows function descriptions, mnemonics, and parameter requirements
    # Dependencies:
    #   - aux_laf function from auxiliary library
    #   - Read access to PBS module file
    #   - grep for pattern matching if filtering is used
    # Arguments:
    #   $1: function_name_filter (optional) - pattern to filter function names
    
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        aux_tec
        return 0
    fi
    
    aux_laf "$FILEPATH_pbs" "$@"
}
# Shows configuration variables overview
# overview variables
# -x (execute)
pbs_var() {
    # Technical Description:
    #   Displays configuration variables specific to PBS module
    #   Uses aux_acu utility to scan and format variable definitions
    #   Shows variable names, values, and usage context from configuration files
    #   Provides organized view of PBS-related environment and configuration settings
    # Dependencies:
    #   - aux_acu function from auxiliary library
    #   - Read access to configuration files
    #   - CONFIG_pbs environment variable must be set
    # Arguments:
    #   $1: -x - explicit execution flag required for consistency
    
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        aux_tec
        return 0
    fi
    
    if [ $# -ne 1 ] || [ "$1" != "-x" ]; then
        aux_use
        return 1
    fi
    
    aux_acu -o "$CONFIG_pbs" "$DIR_FUN/.."
}

# Download Proxmox GPG key and verify checksums
# download and verify
# -x (execute)
pbs_dav() {
    # Technical Description:
    #   Downloads the official Proxmox GPG key for Debian Bookworm from enterprise repository
    #   Performs dual checksum verification using both SHA512 and MD5 algorithms
    #   Validates downloaded key against known good checksums to ensure integrity
    #   Places key in system trusted keyring for APT package verification
    # Dependencies:
    #   - wget for downloading files from remote URLs
    #   - sha512sum for SHA512 checksum calculation
    #   - md5sum for MD5 checksum calculation
    #   - awk for text processing
    #   - Write permissions to /etc/apt/trusted.gpg.d/
    #   - Network access to enterprise.proxmox.com
    # Arguments:
    #   $1: -x - explicit execution flag required for safety due to system modifications
    
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        aux_tec
        return 0
    fi
    
    if [ $# -ne 1 ] || [ "$1" != "-x" ]; then
        aux_use
        return 1
    fi
    
    # Download the GPG key
    wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg

    # Verify SHA512 checksum
    sha512_expected="7da6fe34168adc6e479327ba517796d4702fa2f8b4f0a9833f5ea6e6b48f6507a6da403a274fe201595edc86a84463d50383d07f64bdde2e3658108db7d6dc87"
    sha512_actual=$(sha512sum /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg | awk '{print $1}')

    if [ "$sha512_actual" == "$sha512_expected" ]; then
        echo "SHA512 checksum verified successfully."
    else
        echo "SHA512 checksum verification failed."
    fi

    # Verify MD5 checksum
    md5_expected="41558dc019ef90bd0f6067644a51cf5b"
    md5_actual=$(md5sum /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg | awk '{print $1}')

    if [ "$md5_actual" == "$md5_expected" ]; then
        echo "MD5 checksum verified successfully."
    else
        echo "MD5 checksum verification failed."
    fi
}

# Add Proxmox repository to sources.list if not already present
# setup sources.list
# -x (execute)
pbs_adr() {
    # Technical Description:
    #   Adds the Proxmox Backup Server repository line to APT sources.list
    #   Checks for existing repository entry to prevent duplicates
    #   Uses no-subscription repository for free access to PBS packages
    #   Provides feedback on whether line was added or already existed
    # Dependencies:
    #   - grep for pattern matching in files
    #   - echo for writing to files
    #   - aux_nos function for notification output
    #   - Write permissions to /etc/apt/sources.list
    # Arguments:
    #   $1: -x - explicit execution flag required for safety due to system modifications
    
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        aux_tec
        return 0
    fi
    
    if [ $# -ne 1 ] || [ "$1" != "-x" ]; then
        aux_use
        return 1
    fi
    
    local function_name="${FUNCNAME[0]}"
    line_to_add="deb http://download.proxmox.com/debian/pbs bookworm pbs-no-subscription"
    file="/etc/apt/sources.list"

    if grep -Fxq "$line_to_add" "$file"; then
        aux_nos "$function_name" "Line already exists in $file"
    else
        echo "$line_to_add" >> "$file"
        aux_nos "$function_name" "Line added to $file"
    fi
}

# Restore datastore configuration file with given parameters
# restore datastore
# <datastore_config> <datastore_name> <datastore_path>
pbs_rda() {
    # Technical Description:
    #   Creates or updates the Proxmox Backup Server datastore configuration
    #   Validates configuration parameters and file existence before processing
    #   Uses pattern matching to check for existing datastore entries
    #   Creates configuration file structure with proper formatting if missing
    # Dependencies:
    #   - grep with Perl regex support (-Pzo flags)
    #   - echo with escape sequence support (-e flag)
    #   - aux_use function for usage display
    #   - aux_nos function for notification output
    #   - Write permissions to /etc/proxmox-backup/datastore.cfg
    # Arguments:
    #   $1: datastore_config - configuration identifier or backup source
    #   $2: datastore_name - unique name for the datastore entry
    #   $3: datastore_path - filesystem path where datastore will be located
    
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        aux_tec
        return 0
    fi
    
    if [ $# -ne 3 ]; then
        aux_use
        return 1
    fi
    
    local function_name="${FUNCNAME[0]}"
    local datastore_config="$1"
    local datastore_name="$2"
    local datastore_path="$3"

    # Define the file path to the configuration file
    local file="/etc/proxmox-backup/datastore.cfg"
    # Define the combined lines to be checked within the file
    local combined_lines="datastore: $datastore_name\n\tpath $datastore_path"

    # Check if the file exists
    if [[ -f "$file" ]]; then
        echo "$file exists."

        # Check if the combined lines are present in the file in sequence
        if grep -Pzo "(?s)$combined_lines" "$file"; then
            echo "The lines are present in sequence in $file."
        else
            echo "The lines are not present in sequence in $file. Adding the lines."
            # Append the combined lines to the file
            echo -e "$combined_lines" >> "$file"
            echo "Lines added to $file."
        fi
    else
        echo "$file does not exist. Creating the file and adding the lines."
        # Create the file and add the combined lines
        echo -e "$combined_lines" > "$file"
        echo "File created and lines added."
        echo "$combined_lines"
    fi

    aux_nos "$function_name" "executed ( $1 $2 $3 )"
}

# Monitors and displays various aspects of the Proxmox Backup Server
# pbs monitor
# [option]
pbs_mon() {
    # Technical Description:
    #   Comprehensive monitoring tool for Proxmox Backup Server operations
    #   Provides interactive menu system when no option specified
    #   Executes specific monitoring commands based on user selection
    #   Covers service status, datastore info, tasks, configuration, and system metrics
    # Dependencies:
    #   - systemctl for service status checking
    #   - proxmox-backup-manager for PBS-specific operations
    #   - cat for file content display
    #   - ps and grep for process monitoring
    #   - journalctl for log analysis
    #   - df for storage usage statistics
    #   - ss for network connection monitoring
    #   - aux_mev function for menu interaction
    #   - aux_nos function for notification output
    # Arguments:
    #   $1: option (optional) - monitoring option number (1-11) or descriptive string
    
    if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
        aux_tec
        return 0
    fi
    
    local function_name="${FUNCNAME[0]}"
    local option=""

    # If no argument is provided, prompt for option
    if [ $# -eq 0 ]; then
        echo "Proxmox Backup Server Monitoring Options:"
        echo "1. Show PBS service status"
        echo "2. Display datastore information"
        echo "3. Show running tasks"
        echo "4. Display server configuration"
        echo "5. Check PBS-related processes"
        echo "6. View recent PBS logs"
        echo "7. Show storage usage"
        echo "8. Display user and API token information"
        echo "9. Show backup schedule"
        echo "10. Display network statistics"
        echo "11. All of the above"
        aux_mev "option" "Enter option number" "11"
    else
        option="$1"
    fi

    case "$option" in
        1|"Show PBS service status")
            echo "PBS Service Status:"
            systemctl status proxmox-backup
            ;;
        2|"Display datastore information")
            echo "Datastore Information:"
            proxmox-backup-manager datastore list
            ;;
        3|"Show running tasks")
            echo "Running Tasks:"
            proxmox-backup-manager task list --limit 10
            ;;
        4|"Display server configuration")
            echo "Server Configuration:"
            cat /etc/proxmox-backup/proxmox-backup.ini
            ;;
        5|"Check PBS-related processes")
            echo "PBS-related Processes:"
            ps aux | grep -E 'proxmox-backup'
            ;;
        6|"View recent PBS logs")
            echo "Recent PBS Logs:"
            journalctl -u proxmox-backup -n 50
            ;;
        7|"Show storage usage")
            echo "Storage Usage:"
            df -h /proxmox-backup
            ;;
        8|"Display user and API token information")
            echo "User and API Token Information:"
            proxmox-backup-manager user list
            proxmox-backup-manager api-token list
            ;;
        9|"Show backup schedule")
            echo "Backup Schedule:"
            proxmox-backup-manager schedule list
            ;;
        10|"Display network statistics")
            echo "Network Statistics:"
            ss -tuna | grep -E ':8007|:8008'
            ;;
        11|"All of the above")
            for i in {1..10}; do
                pbs_mon "$i"
                echo "----------------------------------------"
            done
            ;;
        *)
            echo "Invalid option"
            return 1
            ;;
    esac

    aux_nos "$function_name" "PBS monitoring completed"
}

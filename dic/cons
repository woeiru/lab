#!/bin/bash
# Runtime Constants Centralized

# Declare all variables as global first
declare -g LAB_DIR BAS_DIR CON_DIR
declare -g AUX_DIR LOG_DIR TMP_DIR
declare -g ERROR_LOG ERROR_COUNT_FILE ERROR_STATE_FILE
declare -g LOG_STATE_FILE LOG_DEBUG_FILE
declare -g TME_STATE_FILE TME_LOG_FILE
declare -g CACHE_CLEANUP_INTERVAL
declare -ga GENERATION_FOLDERS
declare -gA ERROR_CODES

# Use existing base directories or set defaults
LAB_DIR="${LAB_DIR:-$HOME/lab}"    # Keep existing LAB_DIR if set
BAS_DIR="${BAS_DIR:-$LAB_DIR/bas}"
CON_DIR="${CON_DIR:-$LAB_DIR/con}"
export LAB_DIR BAS_DIR CON_DIR

# Auxiliary directories
AUX_DIR="${AUX_DIR:-$LAB_DIR}" # Updated AUX_DIR to be the same as LAB_DIR
LOG_DIR="${LOG_DIR:-$LAB_DIR/.log}" # Updated LOG_DIR to be within LAB_DIR
TMP_DIR="${TMP_DIR:-$LAB_DIR/.tmp}" # Updated TMP_DIR to be within LAB_DIR
export AUX_DIR LOG_DIR TMP_DIR

# State and log files (using existing patterns)
ERROR_LOG="$LOG_DIR/err.log"
ERROR_COUNT_FILE="$TMP_DIR/err_count"
ERROR_STATE_FILE="$TMP_DIR/err_state"
LOG_STATE_FILE="$TMP_DIR/lo1_state"
LOG_DEBUG_FILE="$LOG_DIR/debug.log"
TME_STATE_FILE="$TMP_DIR/tme_state"
TME_LEVELS_FILE="$TMP_DIR/tme_levels"
TME_LOG_FILE="$LOG_DIR/tme.log"
export ERROR_LOG ERROR_COUNT_FILE ERROR_STATE_FILE
export LOG_STATE_FILE LOG_DEBUG_FILE
export TME_STATE_FILE TME_LEVELS_FILE TME_LOG_FILE


# Define module requirements using nested associative arrays
declare -gA MODULE_VARS
declare -gA MODULE_PATHS
declare -gA MODULE_OPTS

# Initialize module requirements
init_module_requirements() {
debug_log "Initializing module requirements"

    # Error module requirements
    MODULE_VARS[err.ERROR_LOG]=1
    MODULE_VARS[err.TMP_DIR]=1
    MODULE_VARS[err.LOG_DIR]=1

    MODULE_PATHS[err.ERROR_LOG]="file:true"
    MODULE_PATHS[err.TMP_DIR]="dir:true"
    MODULE_PATHS[err.LOG_DIR]="dir:true"

    # Logging module 1 requirements
    MODULE_VARS[lo1.LOG_STATE_FILE]=1
    MODULE_VARS[lo1.LOG_DEBUG_FILE]=1
    MODULE_VARS[lo1.LOG_DIR]=1

    MODULE_PATHS[lo1.LOG_STATE_FILE]="file:true"
    MODULE_PATHS[lo1.LOG_DEBUG_FILE]="file:true"
    MODULE_PATHS[lo1.LOG_DIR]="dir:true"

    # Logging module 2 requirements
    MODULE_VARS[lo2.LOG_DEBUG_FILE]=1
    MODULE_VARS[lo2.LOG_DIR]=1

    MODULE_PATHS[lo2.LOG_DEBUG_FILE]="file:true"
    MODULE_PATHS[lo2.LOG_DIR]="dir:true"

    # Timer module requirements
    MODULE_VARS[tme.TME_STATE_FILE]=1
    MODULE_VARS[tme.TME_LOG_FILE]=1
    MODULE_VARS[tme.LOG_DIR]=1

    MODULE_PATHS[tme.TME_LOG_FILE]="file:true"
    MODULE_PATHS[tme.TME_STATE_FILE]="file:true"
    MODULE_PATHS[tme.TME_LEVELS_FILE]="file:true"
    MODULE_PATHS[tme.LOG_DIR]="dir:true"

debug_log "Module requirements initialization complete"
}

export -f list_module_requirements
export -A MODULE_VARS
export -A MODULE_PATHS
export -A MODULE_OPTS

# Runtime configuration
CACHE_CLEANUP_INTERVAL=300  # 5 minutes
export CACHE_CLEANUP_INTERVAL

GENERATION_FOLDERS=(env fun gen)  # Keep existing array name
export GENERATION_FOLDERS

# Flag to indicate constants are loaded
declare -g CONS_LOADED=1
export CONS_LOADED




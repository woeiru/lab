#!/bin/bash
set -euo pipefail

LAB_DIR="/home/es/lab"
source "$LAB_DIR/lib/gen/aux"

LIB_CORE_DIR="$LAB_DIR/lib/core"
LIB_OPS_DIR="$LAB_DIR/lib/ops"
LIB_GEN_DIR="$LAB_DIR/lib/gen"

process_library_functions() {
    local lib_name="$1"
    local lib_dir="$2"
    
    echo "DEBUG: Processing library: $lib_name from directory: $lib_dir" >&2
    
    local tmp_dir="$LAB_DIR/.tmp/doc"
    
    for file in "$lib_dir"/*; do
        if [[ -f "$file" ]]; then
            echo "DEBUG: Processing file: $file" >&2
            
            local relative_path="${file#$LAB_DIR/}"
            local json_filename="${relative_path//\//_}.json"
            local json_file="$tmp_dir/$json_filename"
            
            echo "DEBUG: Looking for JSON file: $json_file" >&2
            
            if [[ -f "$json_file" ]]; then
                local module_name=$(basename "$file")
                echo "DEBUG: Found JSON for module: $module_name in library: $lib_name" >&2
                
                while IFS= read -r line; do
                    line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                    
                    if [[ "$line" =~ \"name\":[[:space:]]*\"([^\"]+)\" ]]; then
                        local func_name="${BASH_REMATCH[1]}"
                        echo "DEBUG: Found function $func_name in library $lib_name module $module_name" >&2
                    fi
                done < "$json_file"
            fi
        fi
    done
}

echo "=== PROCESSING CORE ==="
process_library_functions "core" "$LIB_CORE_DIR"
echo "=== PROCESSING OPS ==="
process_library_functions "ops" "$LIB_OPS_DIR"
echo "=== PROCESSING GEN ==="
process_library_functions "gen" "$LIB_GEN_DIR"

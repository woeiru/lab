---
- hosts: localhost
  connection: local
  vars:
    config_desk_1: true
    ansible_user_dir: "/root"
    kde_aliases_file: ".aliases_kde"
    shell_rc_files:
      - ".bashrc"
      - ".zshrc"

  tasks:
    - name: Configure desk_1 preferences
      when: config_desk_1 | bool
      block:
        # Konsole configuration
        - name: Ensure .local/share/konsole directory exists
          file:
            path: "{{ ansible_user_dir }}/.local/share/konsole"
            state: directory
            mode: '0755'

        - name: Create Konsole Profile 1
          copy:
            content: |
              [Appearance]
              ColorScheme=SolarizedLight
              Font=Noto Sans Mono,11,-1,5,400,0,0,0,0,0,0,0,0,0,0,1
              [General]
              Name=Profile 1
              Parent=FALLBACK/
              TerminalColumns=133
              TerminalRows=44
            dest: "{{ ansible_user_dir }}/.local/share/konsole/Profile 1.profile"
            mode: '0644'

        - name: Create Konsole Profile 2
          copy:
            content: |
              [Appearance]
              ColorScheme=WhiteOnBlack
              Font=Noto Sans Mono,11,-1,5,400,0,0,0,0,0,0,0,0,0,0,1
              [General]
              Name=Profile 2
              Parent=FALLBACK/
              TerminalColumns=133
              TerminalRows=144
            dest: "{{ ansible_user_dir }}/.local/share/konsole/Profile 2.profile"
            mode: '0644'

        # KWallet configuration
        - name: Ensure KWallet config directory exists
          file:
            path: "{{ ansible_user_dir }}/.config"
            state: directory
            mode: '0755'

        - name: Disable KWallet
          ansible.builtin.ini_file:
            path: "{{ ansible_user_dir }}/.config/kwalletrc"
            section: 'Wallet'
            option: 'Enabled'
            value: 'false'
          register: kwallet_config

        - name: Check if KWallet service exists
          command: systemctl list-unit-files --type=service | grep -E 'kwalletd|kwallet'
          register: kwallet_service_check
          changed_when: false
          failed_when: false

        - name: Restart KWallet service if it exists and configuration changed
          systemd:
            name: "{{ item }}"
            state: restarted
            scope: user
          when:
            - kwallet_config.changed
            - item in kwallet_service_check.stdout
          loop:
            - kwalletd5.service
            - kwalletd.service
          failed_when: false

        - name: Notify user if KWallet service was not found
          debug:
            msg: "KWallet service not found. You may need to restart it manually or it may not be installed on this system."
          when: kwallet_service_check.rc != 0

        # Keyboard layout configuration
        - name: Configure keyboard layout
          copy:
            content: |
              [Layout]
              DisplayNames=,
              LayoutList=us,de
              Use=true
              VariantList=,
            dest: "{{ ansible_user_dir }}/.config/kxkbrc"
            mode: '0644'

        # Enhanced Git and SSH Configuration
        - name: Configure Git global settings to disable GUI prompts
          community.general.git_config:
            scope: global
            name: "{{ item.name }}"
            value: "{{ item.value }}"
          loop:
            - { name: 'core.askPass', value: '' }
            - { name: 'credential.helper', value: '' }
            - { name: 'gui.askpass', value: '' }
            - { name: 'core.editor', value: 'vim' }
            - { name: 'push.default', value: 'simple' }
            - { name: 'credential.modalPrompt', value: 'false' }

        - name: Set global Git environment variables
          lineinfile:
            path: "{{ ansible_user_dir }}/{{ item }}"
            line: "{{ line_item }}"
            create: yes
          loop_control:
            loop_var: line_item
          loop:
            - "export GIT_ASKPASS=''"
            - "export SSH_ASKPASS=''"
            - "unset SSH_ASKPASS"
            - "unset GIT_ASKPASS"
          with_items: "{{ shell_rc_files }}"

        - name: Ensure SSH config directory exists
          ansible.builtin.file:
            path: "{{ ansible_user_dir }}/.ssh"
            state: directory
            mode: '0700'

        - name: Configure SSH to disable password prompting
          ansible.builtin.blockinfile:
            path: "{{ ansible_user_dir }}/.ssh/config"
            create: yes
            mode: '0600'
            block: |
              # Disable SSH_ASKPASS and other GUI prompts
              Host *
                  SetEnv SSH_ASKPASS=''
                  SetEnv GIT_ASKPASS=''
                  PreferredAuthentications publickey,keyboard-interactive,password
                  BatchMode yes
            marker: "# {mark} ANSIBLE MANAGED BLOCK - SSH_ASKPASS configuration"

        - name: Ensure KDE Wallet integration is disabled for Git
          lineinfile:
            path: "{{ ansible_user_dir }}/.config/kdeglobals"
            line: "EnableGitIntegration=false"
            create: yes
            section: "[General]"

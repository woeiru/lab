#!/bin/bash

# Enable debug mode if needed
# set -x

setup_source() {
    local dir="$1"
    local file="$2"
    local base="$3"

    local lib_dir="${dir%/*}/lib"
    local var_dir="${dir%/*}/var"

    if [[ -z "$LABS_ENVIRONMENT_SOURCED" ]]; then
        # Source all .conf files in var directory
        for conf_file in "$var_dir"/*.conf; do
            if [[ -f "$conf_file" ]]; then
                source "$conf_file"
                echo "Sourced $conf_file"
            fi
        done

        # Source all .bash files in lib directory
        for bash_file in "$lib_dir"/*.bash; do
            if [[ -f "$bash_file" ]]; then
                source "$bash_file"
                echo "Sourced $bash_file"
            fi
        done
    else
        echo "Environment already sourced, skipping..."
    fi
}

setup_main() {
    if [ "$#" -ne 3 ]; then
        echo "Usage: $0 MODE OPTION SECTION"l
        echo "MODE: -i (interactive) or -x (executing)"
        echo "OPTION: For -i: 1-6 (display mode), For -x: -d (dry run) or -p (production)"
        echo "SECTION: Function name or -all"
        exit 1
    fi

    local mode="$1"
    local option="$2"
    local section="$3"

    case "$mode" in
        -i)
            setup_interactive_mode "$option" "$section"
            ;;
        -x)
            setup_executing_mode "$option" "$section"
            ;;
        *)
            echo "Invalid mode. Use -i for interactive or -x for executing."
            exit 1
            ;;
    esac
}

setup_interactive_mode() {
    local display_mode="$1"
    local section="$2"

    setup_display_menu "$DIR_SH" "$FILE_SH" "$display_mode" "$section"

    if [[ "$section" != "-all" ]]; then
        read -p "Do you want to execute this code? (y/n): " execute_choice
        if [[ "$execute_choice" == "y" ]]; then
            read -p "Choose execution mode (d for dry run, p for production): " exec_mode
            case "$exec_mode" in
                d)
                    setup_executing_mode "-d" "$section"
                    ;;
                p)
                    setup_executing_mode "-p" "$section"
                    ;;
                *)
                    echo "Invalid execution mode. Exiting."
                    exit 1
                    ;;
            esac
        fi
    else
        select_and_execute_sections
    fi
}

select_and_execute_sections() {
    echo "Which sections do you want to execute?"
    echo "Available sections: ${!MENU_OPTIONS[@]} (or type 'all' for all sections)"
    read -p "Enter section(s) separated by space, or 'all': " sections

    if [[ "$sections" == "all" ]]; then
        sections="${!MENU_OPTIONS[@]}"
    fi

    read -p "Choose execution mode (d for dry run, p for production): " exec_mode
    case "$exec_mode" in
        d)
            option="-d"
            ;;
        p)
            option="-p"
            ;;
        *)
            echo "Invalid execution mode. Exiting."
            exit 1
            ;;
    esac

    for section in $sections; do
        if [[ -n "${MENU_OPTIONS[$section]}" ]]; then
            echo "Executing section: $section"
            setup_executing_mode "$option" "$section"
        else
            echo "Invalid section: $section. Skipping."
        fi
    done
}

setup_executing_mode() {
    local option="$1"
    local section="$2"

    case "$option" in
        -d)
            echo "Executing in dry run mode"
            # Add dry run logic here
            ;;
        -p)
            echo "Executing in production mode"
            # Add production execution logic here
            ;;
        *)
            echo "Invalid option for executing mode. Use -d for dry run or -p for production."
            exit 1
            ;;
    esac

    if [[ "$section" == "-all" ]]; then
        for func in "${!MENU_OPTIONS[@]}"; do
            echo "Executing section: $func"
            ${MENU_OPTIONS[$func]}
        done
    else
        if [[ -n "${MENU_OPTIONS[$section]}" ]]; then
            ${MENU_OPTIONS[$section]}
        else
            echo "Invalid section: $section"
            exit 1
        fi
    fi
}

# Function to expand variables
expand_variables() {
    local line="$1"
    local expanded_line="$line"

    local vars=$(echo "$line" | grep -o '\<[a-zA-Z_][a-zA-Z0-9_]*\>')

    for var in $vars; do
        if [[ -v $var ]]; then
            local value="${!var}"
            expanded_line="${expanded_line//$var/$var = $value}"
        fi
    done

    echo "$expanded_line"
}

# Function to get function description
get_function_description() {
    local func_name="$1"
    local lib_name="${func_name%%-*}"
    local lib_file="/root/lab/lib/${lib_name}.bash"

    if [ ! -f "$lib_file" ]; then
        return
    fi

    local description=$(awk -v fn="$func_name" '
        $0 ~ "^"fn"\\(\\)" {
            if (NR > 2) print lines[NR-3];
            exit;
        }
        {
            lines[NR] = $0;
        }
    ' "$lib_file" | sed 's/^# *//')

    if [ -n "$description" ]; then
        echo "--( $description )--"
    fi
}

setup_display_menu() {
    local dir="$1"
    local file="$2"
    local display_choice="$3"
    local section="$4"

    echo "----------------------------------------------------------------------"
    echo "------------  Scanning file $file for *_xall functions  -------------"
    echo "                                                            "
    echo "--------------------->>(  Displaying chosen option  )<<-----------------------"
    echo "                                                            "

    grep -E '^[a-zA-Z_]+_xall\(\)' "$dir/$file" | while IFS= read -r line; do
        func_name=$(echo "$line" | awk -F'(' '{print $1}')
        if [[ "$section" == "-all" || "${func_name%%_xall}" == "$section" ]]; then
            echo "->>(  ${func_name%%_xall}  )<<------------------------------"

            in_function=false
            first_line=true
            while IFS= read -r inner_line; do
                if $first_line; then
                    first_line=false
                    in_function=true
                    continue
                fi
                if [[ "$inner_line" == "}" ]]; then
                    in_function=false
                    echo ""
                elif $in_function; then
                    case "$display_choice" in
                        1)
                            echo "$inner_line"
                            ;;
                        2)
                            echo "$(expand_variables "$inner_line")"
                            ;;
                        3)
                            if [[ "$inner_line" =~ ^[[:space:]]*([a-zA-Z_-]+) ]]; then
                                local func="${BASH_REMATCH[1]}"
                                local desc="$(get_function_description "$func")"
                                echo "${inner_line} $desc"
                            else
                                echo "$inner_line"
                            fi
                            ;;
                        4)
                            if [[ "$inner_line" =~ ^[[:space:]]*([a-zA-Z_-]+) ]]; then
                                local func="${BASH_REMATCH[1]}"
                                local desc="$(get_function_description "$func")"
                                echo "$(expand_variables "$inner_line") $desc"
                            else
                                echo "$(expand_variables "$inner_line")"
                            fi
                            ;;
                        5)
                            if [[ "$inner_line" =~ ^[[:space:]]*([a-zA-Z_-]+) ]]; then
                                local func="${BASH_REMATCH[1]}"
                                local desc="$(get_function_description "$func")"
                                if [ -n "$desc" ]; then
                                    echo "$func: $desc"
                                fi
                            fi
                            ;;
                        6)
                            if [[ "$inner_line" =~ ^[[:space:]]*([a-zA-Z_-]+) ]]; then
                                local func="${BASH_REMATCH[1]}"
                                local desc="$(get_function_description "$func")"
                                if [ -n "$desc" ]; then
                                    echo "$desc"
                                fi
                            fi
                            ;;
                    esac
                fi
            done < <(sed -n "/^${func_name}()/,/^}/p" "$dir/$file")
        fi
    done
    echo "----------------------------------------------------------------------"
    echo ""
}

# Disable debug mode
set +x
